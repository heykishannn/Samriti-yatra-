<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=360, initial-scale=1.0"/>
  <title>üî• CodeLab - Android Preview</title>
  <style>
    body { margin: 0; background: #0a0f1c; font-family: system-ui,sans-serif; color: white; text-align: center; min-height: 100vh;}
    header { background: linear-gradient(to right, #00f2ff, #00ff88); font-size: 1rem; font-weight: bold; padding: 8px 0;}
    .tab { display: inline-block; padding: 10px 20px; background: #1a1a2e; color: white; border-radius: 5px; margin: 5px 5px 10px; cursor: pointer; border: 1px solid #444;}
    .tab.active { background: #00f2ff; color: black; font-weight: bold;}
    .editor { display: none; width: 90%; height: 130px; margin: auto; background: #111; color: white; border: 2px solid #00f2ff; border-radius: 10px; padding: 10px; font-size: 1rem; resize: vertical; outline: none; font-family: 'Courier New', monospace;}
    #htmlEditor { display: block; }
    .upload-section { margin: 18px auto 0 auto; font-size: 0.95rem; width: 90%; max-width: 400px; background: #181c2c; border-radius: 10px; padding: 10px 10px 8px 10px;}
    .upload-section label { display: block; margin-bottom: 6px; font-weight: bold; color: #00f2ff;}
    input[type="file"] { background: #222; color: white; border: 1px solid #555; border-radius: 5px; padding: 5px; margin-bottom: 6px;}
    #toggleMediaListBtn { background:#00f2ff; color:#222; border:none; border-radius:5px; padding:2px 10px; cursor:pointer; font-size: 1.1rem; margin-left: 5px; margin-bottom: 4px;}
    #toggleMediaListBtn:hover { background: #00c3ff; }
    #mediaListContainer { max-height: 110px; overflow-y: auto; display: none; margin-top: 5px; background: #1a1a2e; border-radius: 6px; padding: 5px; text-align: left;}
    .media-item { background: #222a3a; border-radius: 6px; margin-bottom: 5px; padding: 5px 5px; display: flex; align-items: center; justify-content: space-between; font-size: 0.97rem;}
    .media-item span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 5px;}
    .media-item button { background: #00f2ff; border: none; border-radius: 5px; color: #222; font-size: 0.9rem; cursor: pointer; padding: 2px 7px; margin-left: 5px;}
    .media-item .remove-btn { background: #ff4444; color: #fff; }
    .media-item .remove-btn:hover { background: #ff0000; }
    .buttons { margin: 15px 0 0 0;}
    .buttons button { padding: 10px 20px; margin: 5px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s ease;}
    .buttons .run { background: linear-gradient(to right, #00ff88, #00f2ff); color: black;}
    /* Android phone shape preview */
    .android-frame {
      width: 360px; height: 700px; margin: 28px auto 0 auto;
      background: #181c2c;
      border-radius: 42px;
      box-shadow: 0 0 25px #00f2ff33, 0 8px 32px #000a;
      position: relative;
      padding: 0;
      border: 4px solid #222e;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
    }
    .android-notch {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 120px; height: 24px; background: #222; border-radius: 0 0 18px 18px;
      z-index: 10;
      margin-top: -2px;
    }
    .android-speaker {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      width: 38px; height: 6px; background: #444; border-radius: 3px;
      z-index: 11;
    }
    .android-bottom-bar {
      position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
      width: 60px; height: 7px; background: #444; border-radius: 4px;
      z-index: 11;
    }
    .android-preview-inner {
      width: 328px; height: 620px; background: #0e1520; border-radius: 32px;
      margin-top: 32px; margin-bottom: 24px;
      overflow: hidden; position: relative; box-shadow: 0 0 15px #00f2ff22;
      display: flex; align-items: center; justify-content: center;
    }
    .android-preview-inner iframe {
      width: 100%; height: 100%; border: none; background: white;
      border-radius: 28px;
      display: block;
    }
    .fullscreen-btn {
      margin: 14px auto 0 auto;
      background: #00f2ff;
      color: #222;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      padding: 8px 30px;
      cursor: pointer;
      box-shadow: 0 2px 8px #00f2ff22;
      transition: background 0.2s;
      display: block;
    }
    .fullscreen-btn:hover { background: #00c3ff; }
    /* Fullscreen overlay */
    #fullscreenOverlay {
      display: none;
      position: fixed;
      z-index: 99999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0a0f1c;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #fullscreenContent {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .android-frame.fullscreen {
      width: 98vw; height: 96vh; max-width: 520px; max-height: 98vh;
      min-width: 280px; min-height: 400px;
      margin: 0 auto;
      border-width: 6px;
    }
    .android-frame.fullscreen .android-preview-inner {
      width: 93%; height: 88%; min-width: 220px; min-height: 300px;
      margin-top: 40px; margin-bottom: 32px;
    }
    #fullscreenBackBtn {
      margin-top: 16px;
      background: #00f2ff;
      color: #222;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      padding: 8px 26px;
      cursor: pointer;
      box-shadow: 0 2px 8px #00f2ff22;
      position: absolute;
      top: 22px; left: 28px;
      z-index: 20;
    }
    #fullscreenBackBtn:hover { background: #00c3ff; }
    .convert-btn-main { margin: 18px auto 0 auto; display: block; background: linear-gradient(to right, #ffaa00, #ffbb00); color: #222; border: none; border-radius: 8px; font-size: 1.1rem; padding: 12px 30px; font-weight: bold; cursor: pointer;}
    /* Popup styles */
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;}
    .popup-content { background: #1a1a2e; color: #fff; border-radius: 12px; padding: 22px 18px 18px 18px; width: 92%; max-width: 370px; box-shadow: 0 3px 18px #00f2ff33;}
    .popup-content label { font-weight: bold; color: #00f2ff; margin-top: 8px; display: block;}
    .popup-content input[type="text"], .popup-content input[type="file"] { width: 100%; padding: 8px; margin: 7px 0 14px 0; border-radius: 6px; border: 1px solid #444; background: #222; color: white; font-size: 1rem;}
    .popup-buttons { text-align: center; margin-top: 10px;}
    .popup-buttons button, .popup-buttons a { padding: 10px 18px; margin: 0 8px; border-radius: 8px; font-size: 1rem; cursor: pointer; border: none; display: inline-block;}
    .popup-buttons .convert-btn { background: linear-gradient(to right, #00ff88, #00f2ff); color: black;}
    .popup-buttons .cancel-btn { background: #6c757d; color: white;}
    .popup-status { text-align: center; margin-top: 12px; font-size: 1.05rem; font-weight: bold; color: #00f2ff;}
    .progress-bar-container { width: 100%; background-color: #333; border-radius: 5px; margin-top: 10px; overflow: hidden;}
    .progress-bar { width: 0%; height: 18px; background-color: #00f2ff; border-radius: 5px; text-align: center; line-height: 18px; color: black; font-weight: bold; transition: width 0.5s;}
  </style>
</head>
<body>
  <header>üî• CodeLab - Android Preview</header>
  <div>
    <span class="tab active" id="tab-html">HTML</span>
    <span class="tab" id="tab-css">CSS</span>
    <span class="tab" id="tab-js">JS</span>
  </div>
  <textarea id="htmlEditor" class="editor" placeholder="Write HTML here..."></textarea>
  <textarea id="cssEditor" class="editor" placeholder="Write CSS here..."></textarea>
  <textarea id="jsEditor" class="editor" placeholder="Write JS here..."></textarea>
  <div class="upload-section">
    <label for="mediaUploader">Upload Files (images, audio, video):</label>
    <input type="file" id="mediaUploader" multiple accept="image/*,audio/*,video/*,.mp3,.wav,.ogg,.mp4,.webm" />
    <button id="toggleMediaListBtn">^</button>
    <div id="mediaListContainer"></div>
  </div>
  <div class="buttons">
    <button class="run" id="runBtn">‚ñ∂ Run</button>
  </div>
  <div class="android-frame" id="androidFrame">
    <div class="android-notch"></div>
    <div class="android-speaker"></div>
    <div class="android-preview-inner" id="preview"></div>
    <div class="android-bottom-bar"></div>
  </div>
  <button class="fullscreen-btn" id="fullscreenBtn">Full Screen Preview</button>
  <button class="convert-btn-main" id="convertBtn">Convert APK/ZIP</button>

  <div id="fullscreenOverlay">
    <div id="fullscreenContent">
      <div class="android-frame fullscreen">
        <button id="fullscreenBackBtn">‚Üê Back</button>
        <div class="android-notch"></div>
        <div class="android-speaker"></div>
        <div class="android-preview-inner" id="fullscreenPreview"></div>
        <div class="android-bottom-bar"></div>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="convertPopup" style="display:none;">
    <div class="popup-content">
      <h2 style="text-align:center;color:#00f2ff;margin-top:0;">Convert to APK or ZIP</h2>
      <label for="appNameInput">App Name:</label>
      <input type="text" id="appNameInput" placeholder="My Awesome App">
      <label for="appPackageInput">App Package Name (e.g., com.example.myapp):</label>
      <input type="text" id="appPackageInput" placeholder="com.codelab.myproject">
      <label for="appIconInput">App Icon (.png, .jpg):</label>
      <input type="file" id="appIconInput" accept="image/*">
      <div class="popup-buttons">
        <button class="convert-btn" id="toApkBtn">Convert to APK</button>
        <button class="convert-btn" id="toZipBtn">Convert to ZIP</button>
        <button class="cancel-btn" id="closePopupBtn">Cancel</button>
      </div>
      <div class="popup-status" id="convertStatus"></div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="convertProgress"></div>
      </div>
      <div class="popup-buttons" id="downloadBtns" style="display:none;">
        <a class="convert-btn" id="downloadLink" href="#" download>Download</a>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Tabs & Editors
    const tabs = [
      {id: 'tab-html', editor: 'htmlEditor'},
      {id: 'tab-css', editor: 'cssEditor'},
      {id: 'tab-js', editor: 'jsEditor'},
    ];
    tabs.forEach(tab => {
      document.getElementById(tab.id).addEventListener('click', () => {
        tabs.forEach(t => {
          document.getElementById(t.id).classList.remove('active');
          document.getElementById(t.editor).style.display = 'none';
        });
        document.getElementById(tab.id).classList.add('active');
        document.getElementById(tab.editor).style.display = 'block';
      });
    });

    // LocalStorage: Save/Load code - **Throttling added here for performance**
    const editors = {
      html: document.getElementById('htmlEditor'),
      css: document.getElementById('cssEditor'),
      js: document.getElementById('jsEditor')
    };

    let saveTimeout;
    function saveAll() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        localStorage.setItem('htmlCode', editors.html.value);
        localStorage.setItem('cssCode', editors.css.value);
        localStorage.setItem('jsCode', editors.js.value);
        localStorage.setItem('mediaFiles', JSON.stringify(mediaFiles));
        // console.log("Code and media saved."); // For debugging
      }, 500); // Save after 500ms of no input
    }

    function loadAll() {
      editors.html.value = localStorage.getItem('htmlCode') || '';
      editors.css.value = localStorage.getItem('cssCode') || '';
      editors.js.value = localStorage.getItem('jsCode') || '';
      try {
          mediaFiles = JSON.parse(localStorage.getItem('mediaFiles') || '[]');
          // Ensure dataURLs are correctly formatted if they were stringified strangely
          mediaFiles = mediaFiles.map(file => {
              if (file.data && typeof file.data === 'object' && file.data.data) {
                  // This handles cases where data might be stored as {data: "data:..."}
                  return { name: file.name, type: file.type, data: file.data.data };
              }
              return file;
          });
      } catch (e) {
          console.error("Failed to parse mediaFiles from localStorage:", e);
          mediaFiles = [];
      }
    }

    editors.html.addEventListener('input', () => { saveAll(); runCodeThrottled(); });
    editors.css.addEventListener('input', () => { saveAll(); runCodeThrottled(); });
    editors.js.addEventListener('input', () => { saveAll(); runCodeThrottled(); });


    // Media System
    const mediaUploader = document.getElementById('mediaUploader');
    const mediaListContainer = document.getElementById('mediaListContainer');
    const toggleMediaListBtn = document.getElementById('toggleMediaListBtn');
    let mediaFiles = [];

    function refreshMediaList() {
      mediaListContainer.innerHTML = '';
      if (!mediaFiles.length) {
        mediaListContainer.innerHTML = "<div style='color:#aaa;font-size:0.95rem;'>No media uploaded</div>";
      }
      mediaFiles.forEach((file, idx) => {
        const div = document.createElement('div');
        div.className = 'media-item';
        div.innerHTML = `
          <span title="${file.name}">${file.name}</span>
          <button onclick="insertMedia('${file.name}','${file.type}')">Insert</button>
          <button class="remove-btn" onclick="removeMedia(${idx})">Remove</button>
        `;
        mediaListContainer.appendChild(div);
      });
    }

    // Insert media file's NAME in code (not URL)
    window.insertMedia = function(name, type) {
      let tag = '';
      if (type.startsWith('image/')) {
        tag = `<img src="${name}" alt="">`;
      } else if (type.startsWith('audio/')) {
        tag = `<audio src="${name}" controls></audio>`;
      } else if (type.startsWith('video/')) {
        tag = `<video src="${name}" controls width="320"></video>`;
      } else {
        tag = name;
      }
      const textarea = editors.html;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      textarea.value = textarea.value.slice(0, start) + tag + textarea.value.slice(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + tag.length;
      saveAll();
      runCodeThrottled(); // Use throttled runCode here too
    };

    window.removeMedia = function(idx) {
      mediaFiles.splice(idx, 1);
      saveAll();
      refreshMediaList();
      runCodeThrottled(); // Use throttled runCode here too
    };

    mediaUploader.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        let loadedCount = 0;
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(ev) {
                // Check for duplicate file names and rename if necessary
                let fileName = file.name;
                let counter = 1;
                while (mediaFiles.some(existingFile => existingFile.name === fileName)) {
                    const parts = file.name.split('.');
                    const name = parts.slice(0, -1).join('.');
                    const ext = parts[parts.length - 1];
                    fileName = `${name}(${counter}).${ext}`;
                    counter++;
                }

                mediaFiles.push({
                    name: fileName,
                    type: file.type,
                    data: ev.target.result // Base64 Data URL
                });
                loadedCount++;
                if (loadedCount === files.length) {
                    saveAll();
                    refreshMediaList();
                    runCodeThrottled(); // Use throttled runCode
                }
            };
            reader.onerror = function() {
                console.error("Error reading file:", file.name);
                loadedCount++; // Still increment to avoid blocking if one file fails
                if (loadedCount === files.length) {
                    saveAll();
                    refreshMediaList();
                    runCodeThrottled();
                }
            };
            reader.readAsDataURL(file);
        });
        e.target.value = ''; // Clear the input so same file can be selected again
    });


    toggleMediaListBtn.addEventListener('click', () => {
      if (mediaListContainer.style.display === 'none' || !mediaListContainer.style.display) {
        mediaListContainer.style.display = 'block';
        toggleMediaListBtn.textContent = 'v';
      } else {
        mediaListContainer.style.display = 'none';
        toggleMediaListBtn.textContent = '^';
      }
    });
    mediaListContainer.style.display = 'none';

    function getMediaMap() {
      const map = {};
      mediaFiles.forEach(f => map[f.name] = f.data);
      return map;
    }

    function fillIframeMedia(iframe) {
      const mediaMap = getMediaMap();
      // Use setTimeout with 0 to allow iframe content to render first
      // Or even better, listen for iframe load events if possible, but 0-timeout is a common workaround
      setTimeout(() => {
        if (!iframe.contentDocument) {
            console.warn("Iframe contentDocument not available yet for media fill.");
            return;
        }
        ['img', 'audio', 'video'].forEach(tag => {
          iframe.contentDocument.querySelectorAll(tag).forEach(el => {
            const srcAttr = el.getAttribute('src');
            // Only modify if src is a filename, not already a data URL or external URL
            if (srcAttr && mediaMap[srcAttr] && !srcAttr.startsWith('data:') && !srcAttr.startsWith('http')) {
              el.src = mediaMap[srcAttr];
            }
          });
        });
      }, 50); // A small delay to ensure iframe content is parsed
    }

    let runCodeTimeout;
    function runCode(target = "preview") {
      const html = editors.html.value;
      const css = `<style>${editors.css.value}</style>`;
      const js = `<script>${editors.js.value}<\/script>`;
      const output = html + css + js;
      const container = document.getElementById(target);
      container.innerHTML = ''; // Clear previous content
      const iframe = document.createElement('iframe');
      container.appendChild(iframe);

      // Using srcdoc is generally safer and more performant for simple content
      // and automatically handles cross-origin issues for dynamic content.
      // However, it might have length limitations on older browsers.
      // For very large content, direct document.write is also an option.
      iframe.srcdoc = output;

      iframe.onload = () => {
        fillIframeMedia(iframe);
      };
      // Fallback for older browsers or if srcdoc is too long/fails
      if (!iframe.srcdoc) {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          doc.open();
          doc.write(output);
          doc.close();
          fillIframeMedia(iframe);
      }
    }

    // Throttled version of runCode
    function runCodeThrottled() {
      clearTimeout(runCodeTimeout);
      runCodeTimeout = setTimeout(() => {
        runCode();
      }, 750); // Run code after 750ms of no input
    }

    // Initial load
    loadAll();
    refreshMediaList();
    runCode(); // Initial run on page load

 
